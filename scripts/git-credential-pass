#!/usr/bin/env bash
set -euo pipefail

action=${1:-}

protocol=
host=
path=
username=
password=

# Read key=value pairs from stdin
while IFS='=' read -r key value; do
    [[ -z "${key}" ]] && break
    case "$key" in
        protocol) protocol=$value ;;
        host)     host=$value ;;
        path)     path=$value ;;
        username) username=$value ;;
        password) password=$value ;;
    esac
done

# Where to store this in pass
# Example: git/git.overleaf.com/1234567890abcdef...
store_name="git/${host}${path:+/$path}"

case "$action" in
    get)
        # Try to get password from pass
        if pass show "$store_name" >/dev/null 2>&1; then
            password=$(pass show "$store_name" | head -n1)
            # If Git didn't give us a username, fall back to 'overleaf'
            if [[ -z "${username}" ]]; then
                username="overleaf"
            fi
            echo "username=${username}"
            echo "password=${password}"
        fi
        ;;

    store)
        # If already stored, do nothing
        if pass show "$store_name" >/dev/null 2>&1; then
            exit 0
        fi

        # If Git didn't give a username, just ignore it; Overleaf doesn't care much
        : "${username:=overleaf}"

        # Pass will prompt for your GPG passphrase if needed
        printf '%s\n' "$password" | pass insert -m "$store_name" >/dev/null
        ;;

    erase)
        pass rm -f "$store_name" >/dev/null 2>&1 || true
        ;;

    *)
        # Unknown action; do nothing
        exit 0
        ;;
esac
